ハンズオンメモ
===

■VPCとパブリックサブネットの作成
---
1. マネジメントコンソールにアクセス、VPCダッシュボードへ移動
2. VPC作成ウィザードを起動
3. 「1 個のパブリックサブネットを持つ VPC」を選択
 * ⇛ 本当は「パブリックとプライベートサブネットを持つVPC」の方が目的に近いんだけども。あえてプレーンな状態からやる。
4. VPCの設定とパブリックサブネットの設定
  * VPC名：**wp-practice**
  * VPCのCIDR：**10.0.0.0/16**
    * -> 10.0.0.0〜10.0.255.255の範囲を持つネットワーク
  * パブリックサブネットのCIDR：**10.0.1.0/24**
    * -> 10.0.0.0/16に属し、10.0.1.0〜10.0.1.255の範囲を持つネットワーク
  * ほかデフォルト

### パブリックサブネットをインターネットに接続
1. VPCダッシュボード ->「サブネット」->「パブリックサブネット」を選択
2. ルートテーブルタブを選択し、「rtb-xxxxxxxx」のリンクを選択
3. ルートテーブルの設定を確認
  * 10.0.0.0/16：local
  * 0.0.0.0/0：igw-xxxxxxxx（インターネットゲートウェイのID）
    * VPC内のアドレス範囲以外はインターネットへ流す設定（デフォルトゲートウェイ）

★本には設定手順があるが、ウィザードでパブリックサブネットを作ったため、インターネットゲートウェイ設定済みのルートテーブルまで作成済みであった

#### ★VPCの利用料金
VPC自体の利用に関しては無料。VPC内で起動したEC2などの料金は別途EC2として課金される。
VPN接続を利用する場合はその接続時間に応じて課金される。

■Webサーバーの構築
---

### インスタンスの作成
1. マネジメントコンソールにアクセス、EC2ダッシュボードへ移動 ＃リージョンがVPCと同じになってること
2. メニュー「インスタンス」->「インスタンスの作成」
3. AMIを選択：**Amazon Linux AMI 2015.09.1 (HVM)** を選択
  * Amazon Linux AMIがもう一個あるけど？ ⇛ 仮想化方式（pv or hvm）の違い。仮想化方式が違うと起動出来るインスタンスタイプも異なってくる。
  * [Linux AMI 仮想化タイプ](http://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/virtualization_types.html)
4. インスタンスタイプを選択：**t2.micro** を選択
  * 汎用タイプのインスタンスの中で最も安価なやつ。
    * つい最近（2015/12/15） **t2.nano**  がリリースされて最安の座を奪われましたが、t2.nanoは無償枠ではないため、t2.microを使います。
  * [EC2インスタンスの種類一覧と料金](http://aws.amazon.com/jp/ec2/pricing/)
5. インスタンスの詳細設定を行う（次項）

### インスタンスの詳細情報設定
1. 起動するサブネットを選択：ネットワークをVPC領域、サブネットを **パブリックサブネット** に設定。
2. 自動割り当てパブリック IP：有効化 ＃起動の度にランダムに割り当てられる
3. ネットワークインタフェース：デバイスeth0のプライマリIP に **10.0.1.10** を入力
  * パブリックサブネットのIP範囲（10.0.1.0〜10.0.1.255）からネットワークアドレス10.0.1.0とブロードキャストアドレス10.0.1.255を除いた10.0.1.1〜10.0.1.254の範囲なら何でも良い。
4. インスタンス名をつける：**Webサーバー** と命名
5. セキュリティグループを設定する：
  * 新しいセキュリティグループを作成する を選択
  * 設定値はデフォルトのまま、セキュリティグループ名だけ **WEB-SG** と命名して次へ ＃あらゆる接続元からのSSHを許可する設定
6. インスタンスを起動：「作成」ボタンで起動
7. キーペアを作成してダウンロードしておく：キーペア名を「my-key」へ
  * 後で使うので「~/.ssh/my-key.pem」というパスへ保存
8. 起動 -> ダッシュボード上でインスタンスの状態がrunningになるまで更新かけつつ待つ

**※ここから課金スタート**

### インスタンスへSSH接続する
SSHで接続
```bash:
ssh -i ~/.ssh/my-key.pem ec2-user@xx.xx.xx.xx
```
  * さっきダウンロードしたキーの場所を **-iオプション** で指定
  * ユーザは **ec2-user**
  * IPアドレスはEC2ダッシュボード->「パブリックIP」を確認

ログイン出来た事を確認。満足したらexitで切断。
ついでにifconfigでも打ってIPアドレスなどを確認してみよう。

### httpd(Apache HTTP Server)のインストール〜設定
※先ほど起動したWebサーバーのインスタンスへSSH接続した所からスタート

* yumコマンドでhttpdをインストール
```bash:
sudo yum -y install httpd
```

* httpdを起動
```bash:
sudo service httpd start
```

* 自動起動の設定
```bash:
sudo chkconfig httpd on
```

* 自動起動設定の確認
```bash:
sudo chkconfig --list httpd
```
-> ランレベル「3:on」となっている事

* psコマンドでプロセスを確認
```bash:
ps ax
```
-> 「/usr/sbin/httpd」が存在する事
  * ※オプションの意味
    * a: 全てのプロセスを表示
    * x: 別のターミナルに結び付けられているプロセスも表示

* ネットワークの待受状態を確認
```bash:
sudo lsof -i -n -P
```
「TCP*:80」-> httpdが80番ポートを待受けている事

### ファイアウォールを設定する
1. ブラウザでパブリックIPを指定してアクセスしてみる
「http://xx.xx.xx.xx/」 # パブリックIPアドレスはEC2ダッシュボードで確認
-> *アクセス出来ない事を確認* #応答なし
2. EC2ダッシュボード->「セキュリティグループ」
3. 先ほどWebサーバーインスタンス作成の折に作った「WEB-SG」を選択
4. 「インバウンド」タブで「編集」->「ルールの追加」
  * タイプ: カスタムTCPルール
  * ポート範囲: 80
  * 送信元: 0.0.0.0/0
  * 「保存」をクリック
5. 再びブラウザでパブリックIPを指定してアクセス
「http://xx.xx.xx.xx/」
-> Apache HTTP Serverのデフォルトページが表示されること

■プライベートサブネットとDBサーバーの構築
---

### プライベートサブネットの作成
1. VPCダッシュボードから「サブネット」を選択
  * 先ほど作った「パブリックサブネット」がある事もついでに確認
2. サブネットの作成ウィザードを起動
3. プライベートサブネットの作成
  * 10.0.2.0/24 のCIDRを作成
  * ネームタグで「プライベートサブネット」と命名

※VPC：10.0.0.0/16 において、10.0.3.0～10.0.255.255は未使用となる

### プライベートサブネットのルートテーブルを確認する
1. VPCダッシュボード -> 「サブネット」
2. 先ほど作った「プライベートサブネット」を選択
3. 「ルートテーブル」タブを確認
  * 10.0.0.0/16 -> local の設定のみがあるデフォルトルートテーブルになっている事

※こちらのサブネットはインターネットへ接続しないためこのままの設定とする

### プライベートサブネットにインスタンスを作成する
※Webサーバーと基本手順は同じなので、異なる点のみ記載

1. 起動するサブネットを選択： **プライベートサブネット** に設定。
2. 自動割り当てパブリック IP：無効化 ＃インターネットに繋がらないため
3. ネットワークインタフェース：デバイスeth0のプライマリIP に **「10.0.2.10」** を入力
  * プライベートサブネットのIP範囲のなら何でも良い。
4. インスタンス名をつける：**DBサーバー** と命名
5. セキュリティグループを設定する：
  * 新しいセキュリティグループを作成
  * セキュリティグループ名：**DB-SG** と命名
  * 「ルールの追加」
    * タイプ：**MYSQL/Aurora** を選択
    * 送信元：**任意の場所、0.0.0.0/0**

### WebサーバーからDBサーバーへpingで疎通確認する
1. EC2ダッシュボード->「セキュリティグループ」
2. 先ほど作成した「DB-SG」を選択
3. 「インバウンド」タブで「編集」->「ルールの追加」
  * タイプ: **すべてのICMP**
  * 送信元：**任意の場所、0.0.0.0/0**
  * 「保存」をクリック

* WebサーバーへSSH接続
```bash:
ssh -i ~/.ssh/my-key.pem ec2-user@xx.xx.xx.xx
```

* pingコマンドをDBサーバー向けに実行
```bash:
ping 10.0.2.10
```
->応答 **「64 bytes from 10.0.2.10:...」** が返ること ※Ctrl+C で停止

### DBサーバーへSSH接続する
* 秘密鍵をWebサーバーへアップロードする
```bash:
scp -i ~/.ssh/my-key.pem ~/.ssh/my-key.pem ec2-user@xx.xx.xx.xx:~/.ssh/
```
Webサーバーの~/.ssh/へmy-key.pemを転送

* WebサーバーへSSH接続
```bash:
ssh -i ~/.ssh/my-key.pem ec2-user@xx.xx.xx.xx
```

* 先ほど転送した鍵のパーミッションを自分だけ読める権限に変更
```bash:
chmod 400 ~/.ssh/my-key.pem
```

* 鍵を使い更にDBサーバーへSSH接続する
```bash:
ssh -i ~/.ssh/my-key.pem ec2-user@10.0.2.10
```

■NATサーバーの構築
---

### NATサーバー用のセキュリティグループを作成する
* プライベートサブネットからのHTTP, HTTPS（yumで使うプロトコル）のみ受け入れる
* 同プロトコルの外部向き通信を許可する
* 設定時に必要なのでWebサーバー（踏み台）からのSSHも許可しておく


1. VPCダッシュボード-> 「セキュリティグループ」 -> 「セキュリティグループの作成」
2. セキュリティグループ概要を入力して作成
  * グループ名：**NAT-SG**
  * 説明：NAT Security Group *※日本語不可*
  * VPC：**wp-practice**
3. 作成したNAT-SGを一覧から選択してインバウンドルールを編集
  * プライベートサブネットからのHTTPを許可
    * タイプ：HTTP
    * 送信元：10.0.2.0/24
  * プライベートサブネットからのHTTPSを許可
    * タイプ：HTTPS
    * 送信元：10.0.2.0/24
  * WebサーバーからのSSHを許可
    * タイプ：SSH
    * 送信元：10.0.1.10/32
4. 続けて、アウトバウンドルールを編集
  * 外部へのHTTPを全て許可
    * タイプ：HTTP
    * 送信先：0.0.0.0/0
  * 外部へのHTTPSを許可
    * タイプ：HTTPS
    * 送信先：0.0.0.0/0

### NATサーバーのインスタンスを作成する

1. EC2ダッシュボード ->「インスタンス」->「インスタンスの作成」
2. AMIを選択：コミュニティAMI-> **amzn-ami-vpc-nat-hvm-2015.03.0.x86_64-gp2** を選択
起動するサブネットを選択： **パブリックサブネット** に設定。
3. インスタンスタイプを選択：**t2.micro** を選択
4. ネットワーク：wp-practice
5. サブネット：パブリックサブネット
6. 自動割当パブリックIP：有効化
7. ネットワークインタフェース：デバイスeth0のプライマリIP に **「10.0.1.20」** を入力
  * パブリックサブネットのIP範囲で使ってないやつ（つまり10以外）なら何でも良い。
4. インスタンス名をつける：**NATサーバー** と命名
5. セキュリティグループを設定する：
  * 既存のキュリティグループを選択 -> さっき作った「NAT-SG」
6. キーペア：既存のものを選択
7. 起動

### NATサーバーの送信元／送信先チェックを無効化する

* EC2のデフォルト構成では「パケットを受け取るには、そのインスタンスが送受信するトラフィックの送信元、または、送信先である」という条件が課せられていが、NATサーバではパケットの送信元IPアドレスや宛先IPアドレスを書き換えるため、この条件に引っかかる。
なのでNATサーバでは「送信元、送信先チェック」を無効にする必要がある


1. EC2ダッシュボード-> インスタンス
2. NATサーバーのインスタンスを右クリック-> 「ネットワーキング」->「送信元／送信先の変更チェック」-> 無効化

### プライベートサブネットのルートテーブルを編集する
* プライベートサブネットから外部向けの通信がNATサーバーに流れる様に設定する
* つまり、プライベートサブネットのデフォルトゲートウェイをNATサーバーに設定する


1. VPCダッシュボード->「サブネット」->「プライベートサブネット」->「ルートテーブル」-> ルートテーブルのIDをクリック -> 「ルート」を編集
2. 「別ルートの追加」
  * 送信先：0.0.0.0/0
  * ターゲット：NATサーバー
3. 保存

### プライベートネットワークから外部ネットワークへの疎通確認
* DBサーバーからインターネット上のサーバへHTTP,HTTPSアクセスを試みる

* WebサーバーへSSH接続
```bash:
ssh -i ~/.ssh/my-key.pem ec2-user@xx.xx.xx.xx
```
* DBサーバーへSSH接続する
```bash:
ssh -i ~/.ssh/my-key.pem ec2-user@10.0.2.10
```
* cURLコマンドでインターネットへHTTPアクセス
```bash:
curl http://www.nexcert.com/
curl https://www.nexcert.com/
```

★NATサーバーのインスタンスを停止した状態で同様の操作を試してみよう

■WorｄPressのインストール
---

### DBサーバーへMySQLをインストールする

* DBサーバーへSSH ※手順省略
* MySQLをyumでインストール
```bash:
sudo yum -y install mysql-server
```
* MySQLサーバーを起動
```bash:
sudo service mysqld start
```
* MySQLのrootユーザのパスワードを変更
```bash:
mysqladmin -u root password
-> 新しいパスワードを入力（確認入力あり）
```
* MySQLコンソールにログインし、WordPress用のDBとwordpressユーザを作成。権限を付与。
```bash:
mysql -u root -p
(パスワードを入力)
mysql> CREATE DATABASE wordpress DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci;
mysql> grant all on wordpress.* to wordpress@"%" identified by 'wordpresspasswd';
mysql> flush privileges;
mysql> select user, host from mysql.user;
(wordpressユーザが居ることを確認)
mysql> exit
```
* MySQLサーバーの自動起動設定
```bash:
sudo /sbin/chkconfig mysqld on
```

### WebサーバーへWordPressをインストールする

* WebサーバーへSSH ※手順省略
* PHP, MySQL用ライブラリをyumインストール
```bash:
sudo yum -y install php php-mysql php-mbstring
```
* DB接続用にMySQLコマンドもyumインストール
```bash:
sudo yum -y install mysql
```
* DBサーバー上のMySQLへのログイン確認
```bash:
mysql -h 10.0.2.10 -u wordpress -p
(パスワードを入力)※「wordpresspasswd」の方
(ログイン出来たことを確認)
mysql> exit
```
* WordPressのダウンロード
```bash:
wget http://ja.wordpress.org/latest-ja.tar.gz
```
* アーカイブ展開、ファイル移動、所有者の変更
```bash:
tar xzvf latest-ja.tar.gz
cd wordpress/
sudo cp -r * /var/www/html/
sudo chown -R apache:apache /var/www/html
```

### WordPressの初期設定

* apacheを再起動（起動）する
```bash:
sudo /sbin/service httpd restart
```
* ブラウザでWebサーバーのパブリックIPを入力してアクセス
* WordPressの初期設定画面が表示されること
  1. 「さぁ、始めましょう！」
  2. 設定項目を入力して「送信」
    * データベース名：**wordpress** （デフォルト）
    * ユーザー名：**wordpress**
    * パスワード：**wordpresspasswd**
    * データベースのホスト名：**10.0.2.10**
    * テーブル接頭辞：wp_（デフォルト）
  3. 「インストール実行」
* ようこそ画面が表示されること
  * サイトのタイトル：好きなものを設定
  * ユーザー名：好きなものを設定（ブログへのログイン時必要）
  * パスワード：好きなものを設定（ブログへのログイン時必要）
  * メールアドレス：受信出来るアドレスを設定
  * 「WordPressをインストール」
* ログイン画面が表示されるので、直前に作成したユーザー名、パスワードでログイン
* WordPressダッシュボードが表示されること

**完成！**
記念に記事を投稿しましょう。

【AWS用語集】
---

* リージョン
  * データセンター群を地域別にまとめたもの。世界で９つのリージョンがある。基本的にはサービスの提供対象の地域から物理的に近いリージョンを選ぶと良い（応答時間的な意味で）。ただしリージョンによって提供されるサービスの種類や、課金条件などが異なる場合がある。
* VPC
  * Virtual Private Cloud
* ElasticIP
* EC2
  * Elastic Compute Cloud
* EBS
  * Elastic Block Storage
* AMI
  * Amazon Machine Image。EC2を起動する際に必要な仮想マシーンイメージ。Amazonと名を冠する通り独自形式ではある。Amazonが提供するツール（VMImport）で、他の仮想マシンイメージ（vmdkとか）をAMIに変換出来るらしい。
