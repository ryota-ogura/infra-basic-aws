ハンズオンメモ
===

■VPCとパブリックサブネットの作成
---
1. マネジメントコンソールにアクセス、VPCダッシュボードへ移動
2. VPC作成ウィザードを起動
3. 「1 個のパブリックサブネットを持つ VPC」を選択
 * ⇛ 本当は「パブリックとプライベートサブネットを持つVPC」の方が目的に近いんだけども。あえてプレーンな状態からやる。
4. VPCの設定とパブリックサブネットの設定
  * VPC名：wp-practice
  * VPCのCIDR：10.0.0.0/16
  * パブリックサブネットのCIDR：10.0.1.0/24
  * ほかデフォルト

■パブリックサブネットをインターネットに接続
---
1. VPCダッシュボード⇛サブネット⇛パブリックサブネットを選択
2. ルートテーブルタブを選択し、「rtb-xxxxxxxx」のリンクを選択
3. ルートテーブルの設定を確認
  * 10.0.0.0/16：local
  * 0.0.0.0/0：igw-xxxxxxxx（インターネットゲートウェイのID）
    * VPC内のアドレス範囲以外はインターネットへ流す設定（デフォルトゲートウェイ）

★本には設定手順があるが、ウィザードでパブリックサブネットを作ったため、インターネットゲートウェイ設定済みのルートテーブルまで作成済みであった

### VPCの利用料金
VPC自体の利用に関しては無料。VPC内で起動したEC2などの料金は別途EC2として課金される。
VPN接続を利用する場合はその接続時間に応じて課金される。

■インスタンスの作成
---
1. マネジメントコンソールにアクセス、EC2ダッシュボードへ移動 ＃リージョンがVPCと同じになってること
2. メニュー「Instances」⇛ 「Launch Instance」
3. AMIを選択：「Amazon Linux AMI 2015.09.1 (HVM)」を選択
  * Amazon Linux AMIがもう一個あるけど？ ⇛ 仮想化方式（pv or hvm）の違い。仮想化方式が違うと起動出来るインスタンスタイプも異なってくる。
  * [Linux AMI 仮想化タイプ](http://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/virtualization_types.html)
4. インスタンスタイプを選択：t2.microを選択
  * 汎用タイプのインスタンスの中で最も安価なやつ。
  * [EC2インスタンスの種類一覧と料金](http://aws.amazon.com/jp/ec2/pricing/)
5. インスタンスの詳細設定を行う（次項）


■インスタンスの詳細情報設定
---
1. 起動するサブネットを選択：ネットワークをVPC領域、サブネットをパブリックサブネットに設定。
2. 自動割り当てパブリック IP：有効化 ＃起動の度にランダムに割り当てられる
3. ネットワークインタフェース：PrimaryIP に「10.0.1.10」を入力 ＃パブリックサブネット側の範囲のIPなら何でも良い。
4. インスタンス名をつける：Webサーバーと命名
5. セキュリティグループを設定する：設定値はデフォルトのまま、セキュリティグループ名だけ「WEB-SG」と命名して次へ ＃あらゆる接続元からのSSHを許可する設定
6. インスタンスを起動：「Launch」ボタンで起動
7. キーペアを作成してダウンロードしておく：キーペア名を「my-key」へ
  * 後で使うので「~/.ssh/my-key.pem」というパスへ保存
8. Let's 起動

## ※ここから課金スタート

■インスタンスへSSH接続する
---
1. SSHで接続
```bash:
ssh -i ~/.ssh/my-key.pem ec2-user@xx.xx.xx.xx
```
  * さっきダウンロードしたキーを-iオプションで指定
  * ユーザは「ec2-user」
  * IPアドレスはEC2ダッシュボード->「パブリックIP」を確認

2. ログイン出来た事を確認。満足したらexitで切断。
ついでにifconfigでも打ってIPアドレスなどを確認してみよう。

■httpd(Apache HTTP Server))のインストール〜設定
---
1. 先ほど起動したWebサーバーのインスタンスへSSH接続
2. yumコマンドでhttpdをインストール
```bash:
sudo yum -y install httpd
```
3. httpdを起動
```bash:
sudo service httpd start
```
4. 自動起動の設定
```bash:
sudo chkconfig httpd on
```
5. 自動起動設定の確認
```bash:
sudo chkconfig --list httpd
```
-> ランレベル「3:on」となっている事
6. psコマンドでプロセスを確認
```bash:
ps -ax
```
-> 「/usr/sbin/httpd」が存在する事
  * ※オプションの意味
    * a: 全てのプロセスを表示
    * x: 別のターミナルに結び付けられているプロセスも表示
7. ネットワークの待受状態を確認
```bash:
sudo lsof -i -n -P
```
「TCP*:80」-> httpdが80番ポートを待受けている事

■ファイアウォールを設定する
---
1. ブラウザでパブリックIPを指定してアクセスしてみる
「http://xx.xx.xx.xx/」 # パブリックIPアドレスはEC2ダッシュボードで確認
-> *アクセス出来ない事を確認* #応答なし
2. EC2ダッシュボード->「セキュリティグループ」->「VPCセキュリティグループ」
3. 先ほどWebサーバーインスタンス作成の折に作った「WEB-SG」を選択
4. Inboundに下記項目を入力
  * Create a new rule: Custom TCP rule
  * Port range: 80
  * Source: 0.0.0.0/0
  * Add Ruleをクリック
5. Apply Rule Changesをクリック
6. 再びブラウザでパブリックIPを指定してアクセス
「http://xx.xx.xx.xx/」
-> Apache HTTP Serverのデフォルトページが表示されること

■プライベートサブネットの作成
---
1. VPCダッシュボードから「サブネット」を選択
  * 先ほど作った「パブリックサブネット」がある事もついでに確認
2. サブネットの作成ウィザードを起動
3. プライベートサブネットの作成
  * 10.0.2.0/24 のCIDRを作成
  * ネームタグで「プライベートサブネット」と命名

※VPC：10.0.0.0/16 において、10.0.3.0～10.0.255.255は未使用となる



### 【AWS用語集】

* リージョン
  * データセンター群を地域別にまとめたもの。世界で９つのリージョンがある。基本的にはサービスの提供対象の地域から物理的に近いリージョンを選ぶと良い（応答時間的な意味で）。ただしリージョンによって提供されるサービスの種類や、課金条件などが異なる場合がある。
* VPC
  * Virtual Private Cloud
* ElasticIP
* EC2
  * Elastic Compute Cloud
* EBS
  * Elastic Block Storage
* AMI
  * Amazon Machine Image。EC2を起動する際に必要な仮想マシーンイメージ。Amazonと名を冠する通り独自形式ではある。Amazonが提供するツール（VMImport）で、他の仮想マシンイメージ（vmdkとか）をAMIに変換出来るらしい。
