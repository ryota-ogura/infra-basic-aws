ハンズオンメモ
===

■VPCとパブリックサブネットの作成
---
1. マネジメントコンソールにアクセス、VPCダッシュボードへ移動
2. VPC作成ウィザードを起動
3. 「1 個のパブリックサブネットを持つ VPC」を選択
 * ⇛ 本当は「パブリックとプライベートサブネットを持つVPC」の方が目的に近いんだけども。あえてプレーンな状態からやる。
4. VPCの設定とパブリックサブネットの設定
  * VPC名：**wp-practice**
  * VPCのCIDR：**10.0.0.0/16**
    * -> 10.0.0.0〜10.0.255.255の範囲を持つネットワーク
  * パブリックサブネットのCIDR：**10.0.1.0/24**
    * -> 10.0.0.0/16に属し、10.0.1.0〜10.0.1.255の範囲を持つネットワーク
  * ほかデフォルト

■パブリックサブネットをインターネットに接続
---
1. VPCダッシュボード ->「サブネット」->「パブリックサブネット」を選択
2. ルートテーブルタブを選択し、「rtb-xxxxxxxx」のリンクを選択
3. ルートテーブルの設定を確認
  * 10.0.0.0/16：local
  * 0.0.0.0/0：igw-xxxxxxxx（インターネットゲートウェイのID）
    * VPC内のアドレス範囲以外はインターネットへ流す設定（デフォルトゲートウェイ）

★本には設定手順があるが、ウィザードでパブリックサブネットを作ったため、インターネットゲートウェイ設定済みのルートテーブルまで作成済みであった

### VPCの利用料金
VPC自体の利用に関しては無料。VPC内で起動したEC2などの料金は別途EC2として課金される。
VPN接続を利用する場合はその接続時間に応じて課金される。

■インスタンスの作成
---
1. マネジメントコンソールにアクセス、EC2ダッシュボードへ移動 ＃リージョンがVPCと同じになってること
2. メニュー「インスタンス」->「インスタンスの作成」
3. AMIを選択：**Amazon Linux AMI 2015.09.1 (HVM)** を選択
  * Amazon Linux AMIがもう一個あるけど？ ⇛ 仮想化方式（pv or hvm）の違い。仮想化方式が違うと起動出来るインスタンスタイプも異なってくる。
  * [Linux AMI 仮想化タイプ](http://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/virtualization_types.html)
4. インスタンスタイプを選択：**t2.micro** を選択
  * 汎用タイプのインスタンスの中で最も安価なやつ。
  * [EC2インスタンスの種類一覧と料金](http://aws.amazon.com/jp/ec2/pricing/)
5. インスタンスの詳細設定を行う（次項）


■インスタンスの詳細情報設定
---
1. 起動するサブネットを選択：ネットワークをVPC領域、サブネットを **パブリックサブネット** に設定。
2. 自動割り当てパブリック IP：有効化 ＃起動の度にランダムに割り当てられる
3. ネットワークインタフェース：デバイスeth0のプライマリIP に **10.0.1.10** を入力
  * パブリックサブネットのIP範囲（10.0.1.0〜10.0.1.255）からネットワークアドレス10.0.1.0とブロードキャストアドレス10.0.1.255を除いた10.0.1.1〜10.0.1.254の範囲なら何でも良い。
4. インスタンス名をつける：**Webサーバー** と命名
5. セキュリティグループを設定する：
  * 新しいセキュリティグループを作成する を選択
  * 設定値はデフォルトのまま、セキュリティグループ名だけ **WEB-SG** と命名して次へ ＃あらゆる接続元からのSSHを許可する設定
6. インスタンスを起動：「作成」ボタンで起動
7. キーペアを作成してダウンロードしておく：キーペア名を「my-key」へ
  * 後で使うので「~/.ssh/my-key.pem」というパスへ保存
8. 起動 -> ダッシュボード上でインスタンスの状態がrunningになるまで更新かけつつ待つ

## ※ここから課金スタート

■インスタンスへSSH接続する
---
1. SSHで接続
```bash:
ssh -i ~/.ssh/my-key.pem ec2-user@xx.xx.xx.xx
```
  * さっきダウンロードしたキーの場所を **-iオプション** で指定
  * ユーザは **ec2-user**
  * IPアドレスはEC2ダッシュボード->「パブリックIP」を確認

2. ログイン出来た事を確認。満足したらexitで切断。
ついでにifconfigでも打ってIPアドレスなどを確認してみよう。

■httpd(Apache HTTP Server))のインストール〜設定
---
1. 先ほど起動したWebサーバーのインスタンスへSSH接続
2. yumコマンドでhttpdをインストール
```bash:
sudo yum -y install httpd
```
3. httpdを起動
```bash:
sudo service httpd start
```
4. 自動起動の設定
```bash:
sudo chkconfig httpd on
```
5. 自動起動設定の確認
```bash:
sudo chkconfig --list httpd
```
-> ランレベル「3:on」となっている事
6. psコマンドでプロセスを確認
```bash:
ps ax
```
-> 「/usr/sbin/httpd」が存在する事
  * ※オプションの意味
    * a: 全てのプロセスを表示
    * x: 別のターミナルに結び付けられているプロセスも表示
7. ネットワークの待受状態を確認
```bash:
sudo lsof -i -n -P
```
「TCP*:80」-> httpdが80番ポートを待受けている事

■ファイアウォールを設定する
---
1. ブラウザでパブリックIPを指定してアクセスしてみる
「http://xx.xx.xx.xx/」 # パブリックIPアドレスはEC2ダッシュボードで確認
-> *アクセス出来ない事を確認* #応答なし
2. EC2ダッシュボード->「セキュリティグループ」
3. 先ほどWebサーバーインスタンス作成の折に作った「WEB-SG」を選択
4. 「インバウンド」タブで「編集」->「ルールの追加」
  * タイプ: カスタムTCPルール
  * ポート範囲: 80
  * 送信元: 0.0.0.0/0
  * 「保存」をクリック
5. 再びブラウザでパブリックIPを指定してアクセス
「http://xx.xx.xx.xx/」
-> Apache HTTP Serverのデフォルトページが表示されること

■プライベートサブネットの作成
---
1. VPCダッシュボードから「サブネット」を選択
  * 先ほど作った「パブリックサブネット」がある事もついでに確認
2. サブネットの作成ウィザードを起動
3. プライベートサブネットの作成
  * 10.0.2.0/24 のCIDRを作成
  * ネームタグで「プライベートサブネット」と命名

※VPC：10.0.0.0/16 において、10.0.3.0～10.0.255.255は未使用となる

■プライベートサブネットのルートテーブルを確認する
---
1. VPCダッシュボード -> 「サブネット」
2. 先ほど作った「プライベートサブネット」を選択
3. 「ルートテーブル」タブを確認
  * 10.0.0.0/16 -> local の設定のみがあるデフォルトルートテーブルになっている事

※こちらのサブネットはインターネットへ接続しないためこのままの設定とする

■プライベートサブネットにインスタンスを作成する
---
※Webサーバーと基本手順は同じなので、異なる点のみ記載
1. 起動するサブネットを選択： **プライベートサブネット** に設定。
2. 自動割り当てパブリック IP：無効化 ＃インターネットに繋がらないため
3. ネットワークインタフェース：デバイスeth0のプライマリIP に **「10.0.2.10」** を入力
  * プライベートサブネットのIP範囲のなら何でも良い。
4. インスタンス名をつける：**DBサーバー** と命名
5. セキュリティグループを設定する：
  * 新しいセキュリティグループを作成
  * セキュリティグループ名：**DB-SG** と命名
  * 「ルールの追加」
    * タイプ：**MYSQL/Aurora** を選択
    * 送信元：**任意の場所、0.0.0.0/0**

■WeｂサーバーからDBサーバーへpingで疎通確認する
---
1. EC2ダッシュボード->「セキュリティグループ」
2. 先ほど作成した「DB-SG」を選択
3. 「インバウンド」タブで「編集」->「ルールの追加」
  * タイプ: **すべてのICMP**
  * 送信元：**任意の場所、0.0.0.0/0**
  * 「保存」をクリック
4. WebサーバーへSSH接続
```bash:
ssh -i ~/.ssh/my-key.pem ec2-user@xx.xx.xx.xx
```
5. pingコマンドをDBサーバー向けに実行
```bash:
ping 10.0.2.10
```
->応答 **「64 bytes from 10.0.2.10:...」** が返ること ※Ctrl+C で停止

■DBサーバーへSSH接続する
---
1. 秘密鍵をWebサーバーへアップロードする
```bash:
scp -i ~/.ssh/my-key.pem ~/.ssh/my-key.pem ec2-user@xx.xx.xx.xx:~/.ssh/
```
Webサーバーの~/.ssh/へmy-key.pemを転送

2. WebサーバーへSSH接続
```bash:
ssh -i ~/.ssh/my-key.pem ec2-user@xx.xx.xx.xx
```
3. 先ほど転送した鍵のパーミッションを自分だけ読める権限に変更
```bash:
chmod 400 ~/.ssh/my-key.pem
```
4. 鍵を使い更にDBサーバーへSSH接続する
```bash:
ssh -i ~/.ssh/aws-key.pem ec2-user@10.0.2.10
```

### 【AWS用語集】

* リージョン
  * データセンター群を地域別にまとめたもの。世界で９つのリージョンがある。基本的にはサービスの提供対象の地域から物理的に近いリージョンを選ぶと良い（応答時間的な意味で）。ただしリージョンによって提供されるサービスの種類や、課金条件などが異なる場合がある。
* VPC
  * Virtual Private Cloud
* ElasticIP
* EC2
  * Elastic Compute Cloud
* EBS
  * Elastic Block Storage
* AMI
  * Amazon Machine Image。EC2を起動する際に必要な仮想マシーンイメージ。Amazonと名を冠する通り独自形式ではある。Amazonが提供するツール（VMImport）で、他の仮想マシンイメージ（vmdkとか）をAMIに変換出来るらしい。
