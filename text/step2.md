■Webサーバーの構築
===

[Amazon EC2 とは](http://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/concepts.html)

### インスタンスの作成

[インスタンスとAMI](http://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/ec2-instances-and-amis.html)

1. マネジメントコンソールにアクセス、EC2ダッシュボードへ移動 ＃リージョンがVPCと同じになってること
2. メニュー「インスタンス」->「インスタンスの作成」
3. AMIを選択：**Amazon Linux AMI 2015.09.1 (HVM)** を選択
  * [Linux AMI 仮想化タイプ](http://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/virtualization_types.html)
4. インスタンスタイプを選択：**t2.micro** を選択
  * 汎用タイプのインスタンスの中で最も安価なやつ。
  * [EC2インスタンスの種類一覧と料金](http://aws.amazon.com/jp/ec2/pricing/)
5. インスタンスの詳細設定を行う（次項）

### インスタンスの詳細情報設定
1. 起動するサブネットを選択：ネットワークをVPC領域、サブネットを **[チーム名]-パブリックサブネット** に設定。
2. 自動割り当てパブリック IP：有効化 ＃起動の度にランダムに割り当てられる
3. ネットワークインタフェース：デバイスeth0のプライマリIP に **10.0.1.10** を入力
  * パブリックサブネットのIP範囲（10.0.1.0〜10.0.1.255）からネットワークアドレス10.0.1.0とブロードキャストアドレス10.0.1.255を除いた10.0.1.1〜10.0.1.254の範囲なら何でも良い。
4. インスタンス名をつける：**[チーム名]-Webサーバー** と命名
5. セキュリティグループを設定する：
  * 新しいセキュリティグループを作成する を選択
  * 設定値はデフォルトのまま、セキュリティグループ名だけ **[チーム名]-WEB-SG** と命名して次へ ＃あらゆる接続元からのSSHを許可する設定
6. インスタンスを起動：「作成」ボタンで起動
7. キーペアを作成してダウンロードしておく：キーペア名を「[チーム名]--key」へ
  * 後で使うので「~/.ssh/my-key.pem」というパスへ保存
8. 起動 -> ダッシュボード上でインスタンスの状態がrunningになるまで更新かけつつ待つ

**※ここから課金スタート**

### インスタンスへSSH接続する
SSHで接続
```bash:
ssh -i ~/.ssh/my-key.pem ec2-user@xx.xx.xx.xx
```
  * さっきダウンロードしたキーの場所を **-iオプション** で指定
  * ユーザは **ec2-user**
  * IPアドレスはEC2ダッシュボード->「パブリックIP」を確認

ログイン出来た事を確認。満足したらexitで切断。
ついでにifconfigでも打ってIPアドレスなどを確認してみよう。

### httpd(Apache HTTP Server)のインストール〜設定
※先ほど起動したWebサーバーのインスタンスへSSH接続した所からスタート

* yumコマンドでhttpdをインストール
```bash:
sudo yum -y install httpd
```

* httpdを起動
```bash:
sudo service httpd start
```

* 自動起動の設定
```bash:
sudo chkconfig httpd on
```

* 自動起動設定の確認
```bash:
sudo chkconfig --list httpd
```
-> ランレベル「3:on」となっている事

* psコマンドでプロセスを確認
```bash:
ps ax
```
-> 「/usr/sbin/httpd」が存在する事
  * ※オプションの意味
    * a: 全てのプロセスを表示
    * x: 別のターミナルに結び付けられているプロセスも表示

* ネットワークの待受状態を確認
```bash:
sudo lsof -i -n -P
```
「TCP*:80」-> httpdが80番ポートを待受けている事

### ファイアウォールを設定する
1. ブラウザでパブリックIPを指定してアクセスしてみる
「http://xx.xx.xx.xx/」 # パブリックIPアドレスはEC2ダッシュボードで確認
-> *アクセス出来ない事を確認* #応答なし
2. EC2ダッシュボード->「セキュリティグループ」
3. 先ほどWebサーバーインスタンス作成の折に作った「[チーム名]-WEB-SG」を選択
4. 「インバウンド」タブで「編集」->「ルールの追加」
  * タイプ: カスタムTCPルール
  * ポート範囲: 80
  * 送信元: 0.0.0.0/0
  * 「保存」をクリック
5. 再びブラウザでパブリックIPを指定してアクセス
「http://xx.xx.xx.xx/」
-> Apache HTTP Serverのデフォルトページが表示されること
