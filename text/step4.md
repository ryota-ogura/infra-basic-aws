■NATサーバーの構築
===

### NATサーバー用のセキュリティグループを作成する
* プライベートサブネットからのHTTP, HTTPS（yumで使うプロトコル）のみ受け入れる
* 同プロトコルの外部向き通信を許可する
* 設定時に必要なのでWebサーバー（踏み台）からのSSHも許可しておく

1. VPCダッシュボード-> 「セキュリティグループ」 -> 「セキュリティグループの作成」
2. セキュリティグループ概要を入力して作成
  * グループ名：**[チーム名]-NAT-SG**
  * 説明：NAT Security Group *※日本語不可*
  * VPC：**[チーム名]-wp-practice**
3. 作成した[チーム名]-NAT-SGを一覧から選択してインバウンドルールを編集
  * プライベートサブネットからのHTTPを許可
    * タイプ：HTTP
    * 送信元：10.0.2.0/24
  * プライベートサブネットからのHTTPSを許可
    * タイプ：HTTPS
    * 送信元：10.0.2.0/24
  * WebサーバーからのSSHを許可
    * タイプ：SSH
    * 送信元：10.0.1.10/32
4. 続けて、アウトバウンドルールを編集
  * 外部へのHTTPを全て許可
    * タイプ：HTTP
    * 送信先：0.0.0.0/0
  * 外部へのHTTPSを許可
    * タイプ：HTTPS
    * 送信先：0.0.0.0/0

### NATサーバーのインスタンスを作成する

1. EC2ダッシュボード ->「インスタンス」->「インスタンスの作成」
2. AMIを選択：コミュニティAMI-> **amzn-ami-vpc-nat-hvm-2015.03.0.x86_64-gp2** を選択
起動するサブネットを選択： **[チーム名]-パブリックサブネット** に設定。
3. インスタンスタイプを選択：**t2.micro** を選択
4. ネットワーク：[チーム名]-wp-practice
5. サブネット：[チーム名]-パブリックサブネット
6. 自動割当パブリックIP：有効化
7. ネットワークインタフェース：デバイスeth0のプライマリIP に **「10.0.1.20」** を入力
  * パブリックサブネットのIP範囲で使ってないやつ（つまり10以外）なら何でも良い。
4. インスタンス名をつける：**[チーム名]-NATサーバー** と命名
5. セキュリティグループを設定する：
  * 既存のキュリティグループを選択 -> さっき作った「[チーム名]-NAT-SG」
6. キーペア：既存のものを選択
7. 起動

### NATサーバーの送信元／送信先チェックを無効化する

* EC2のデフォルト構成では「パケットを受け取るには、そのインスタンスが送受信するトラフィックの送信元、または、送信先である」という条件が課せられていが、NATサーバではパケットの送信元IPアドレスや宛先IPアドレスを書き換えるため、この条件に引っかかる。
なのでNATサーバでは「送信元、送信先チェック」を無効にする必要がある


1. EC2ダッシュボード-> インスタンス
2. NATサーバーのインスタンスを右クリック-> 「ネットワーキング」->「送信元／送信先の変更チェック」-> 無効化

### プライベートサブネットのルートテーブルを編集する
* プライベートサブネットから外部向けの通信がNATサーバーに流れる様に設定する
* つまり、プライベートサブネットのデフォルトゲートウェイをNATサーバーに設定する


1. VPCダッシュボード->「サブネット」->「[チーム名]-プライベートサブネット」->「ルートテーブル」-> ルートテーブルのIDをクリック -> 「ルート」を編集
2. 「別ルートの追加」
  * 送信先：0.0.0.0/0
  * ターゲット：[チーム名]-NATサーバー
3. 保存

### プライベートネットワークから外部ネットワークへの疎通確認
* DBサーバーからインターネット上のサーバへHTTP,HTTPSアクセスを試みる

* WebサーバーへSSH接続
```bash:
ssh -i ~/.ssh/my-key.pem ec2-user@xx.xx.xx.xx
```
* DBサーバーへSSH接続する
```bash:
ssh -i ~/.ssh/my-key.pem ec2-user@10.0.2.10
```
* cURLコマンドでインターネットへHTTPアクセス
```bash:
curl http://www.nexcert.com/
curl https://www.nexcert.com/
```

★NATサーバーのインスタンスを停止した状態で同様の操作を試してみよう
